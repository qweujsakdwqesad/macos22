name: Sign iOS IPA (Real Device Ready)

on:
  workflow_dispatch:
    inputs:
      ipa_url:
        description: "Direct download URL for the IPA to sign"
        required: true

jobs:
  sign:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install fastlane
          echo "‚úÖ Fastlane installed"

      - name: Download IPA
        run: |
          echo "üì¶ Downloading IPA..."
          curl -L -o app.ipa "${{ github.event.inputs.ipa_url }}"
          ls -lh app.ipa

      - name: Extract IPA
        run: |
          mkdir extracted
          cd extracted
          unzip ../app.ipa
          echo "‚úÖ IPA extracted"

      - name: Create Xcode project for signing
        run: |
          cd extracted
          mkdir XcodeProj
          cd XcodeProj
          echo "Creating temporary Xcode project..."
          cat <<EOF > project.pbxproj
          // Empty placeholder project
          EOF

     - name: Setup Fastlane auth
  env:
    FASTLANE_USER: ${{ secrets.APPLE_ID }}
    FASTLANE_PASSWORD: ${{ secrets.APPLE_PASS }}
  run: |
    echo "üîê Authenticating with Apple..."
    fastlane sigh --username "$FASTLANE_USER" --adhoc true --skip_certificate_verification

      - name: Generate provisioning profile and sign
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASS: ${{ secrets.APPLE_PASS }}
        run: |
          cd extracted
          echo "üîß Creating temporary project for signing..."
          fastlane sigh --username "$APPLE_ID" --adhoc true --skip_certificate_verification
          echo "‚úÖ Provisioning profile downloaded"

          PROFILE=$(ls *.mobileprovision | head -n 1)
          echo "Using profile: $PROFILE"

          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp "$PROFILE" ~/Library/MobileDevice/Provisioning\ Profiles/

          APP_PATH=$(find Payload -name "*.app" | head -n 1)
          echo "Signing $APP_PATH..."
          codesign -f -s "Apple Development" --entitlements entitlements.plist "$APP_PATH"

      - name: Repackage Signed IPA
        run: |
          cd extracted
          zip -r ../signed-app.ipa Payload/
          cd ..

      - name: Upload Signed IPA
        uses: actions/upload-artifact@v4
        with:
          name: signed-ipa
          path: signed-app.ipa
